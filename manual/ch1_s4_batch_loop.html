<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Running multiple simulations &mdash; WaveBlocksND devel documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'devel',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="WaveBlocksND devel documentation" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">WaveBlocksND devel documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="running-multiple-simulations">
<h1>Running multiple simulations<a class="headerlink" href="#running-multiple-simulations" title="Permalink to this headline">¶</a></h1>
<p>Now we know how to run a single simulation. But most of the time we want
to run a multitude of simulations. This is not more difficult, only the work-flow
changes a little bit. Throughout the next section we work in an arbitrary
directory. All files referenced are assumed to lie within this working directory.</p>
<div class="section" id="preparation-and-meta-configurations">
<h2>Preparation and Meta-configurations<a class="headerlink" href="#preparation-and-meta-configurations" title="Permalink to this headline">¶</a></h2>
<p>First we need to generate a bunch of configurations. Of course we could write
all the files by hand. However, for a set of simulations where just one or a
few parameters vary, we can avoid this tedious work. The tool that takes over
the task is named <tt class="docutils literal"><span class="pre">ConfigurationGenerator.py</span></tt>. It takes a so called <cite>meta configuration</cite>
and then produces a set of ordinary configuration files. The synopsis for this
tool is:</p>
<div class="highlight-python"><div class="highlight"><pre>ConfigurationGenerator.py --help
usage: ConfigurationGenerator.py [-h] [-d DESTINATION] metaconfiguration

positional arguments:
  metaconfiguration     The meta-configuration file.

optional arguments:
  -h, --help            show this help message and exit
  -d DESTINATION, --destination DESTINATION
                        The destination where to store the configurations
                        generated.
</pre></div>
</div>
<p>Let&#8217;s look at a simple example: assume that our sample meta configuration file
is <tt class="docutils literal"><span class="pre">metaconfiguration_02.py</span></tt>, its content is reprinted below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Global parameters that stay the same for all simulations :</span>
<span class="n">GP</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;algorithm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">fourier</span><span class="se">\&quot;</span><span class="s">&quot;</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;potential&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">delta_gap</span><span class="se">\&quot;</span><span class="s">&quot;</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;[ (1.0j, 1.0-6.0j, 0.0, 1.0, -6.0), (1.0j, 1.0-6.0j, 0.0, 1.0, -6.0) ]&quot;</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;coefficients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[(</span><span class="mi">0</span> <span class="p">,</span><span class="mf">1.0</span><span class="p">)],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)]</span> <span class="p">]</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;basis_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;ngn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">12</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;f&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.0</span>
<span class="n">GP</span><span class="p">[</span><span class="s">&quot;write_nth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c"># Local parameters that change with each simulation</span>
<span class="n">LP</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">LP</span><span class="p">[</span><span class="s">&quot;eps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
<span class="n">LP</span><span class="p">[</span><span class="s">&quot;delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;0.5*eps&quot;</span><span class="p">,</span> <span class="s">&quot;1.0*eps&quot;</span><span class="p">,</span> <span class="s">&quot;1.5*eps&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The file is just another plain <cite>Python</cite> file with only informal constraints.
There must be two dicts named <tt class="docutils literal"><span class="pre">GP</span></tt> and <tt class="docutils literal"><span class="pre">LP</span></tt> in the top level name-space.
The first one, <tt class="docutils literal"><span class="pre">GP</span></tt>, contains all the parameters that are <cite>global</cite> to the
set of configuration. While the second one, <tt class="docutils literal"><span class="pre">LP</span></tt>, contains lists of the
parameters that vary with each simulation. The configuration generator then
computes the Cartesian product of all these lists in <tt class="docutils literal"><span class="pre">LP</span></tt>. Then, for each
tuple of this Cartesian product it adds all parameters from <tt class="docutils literal"><span class="pre">GP</span></tt>, yielding
a single configuration. Additionally to these two variables there can be
another one which is used for global preambles. This variable has to be called
<tt class="docutils literal"><span class="pre">PA</span></tt> and holds a (multi-line) <cite>Python</cite> string of valid <cite>Python</cite> code. These
statements are written to the very top of every configuration file generated.</p>
<p>We can run the configuration generator as:</p>
<div class="highlight-python"><div class="highlight"><pre>ConfigurationGenerator.py metaconfiguration_02.py
</pre></div>
</div>
<p>and it will create the directory <tt class="docutils literal"><span class="pre">autogen_configurations</span></tt> where it puts
all the configuration files. Let&#8217;s take a look into this directory:</p>
<div class="highlight-python"><div class="highlight"><pre>ls -l autogen_configurations/
</pre></div>
</div>
<p>prints:</p>
<div class="highlight-python"><div class="highlight"><pre>Parameters[eps=0.1][delta=0.5eps].py
Parameters[eps=0.1][delta=1.0eps].py
Parameters[eps=0.1][delta=1.5eps].py
Parameters[eps=0.5][delta=0.5eps].py
Parameters[eps=0.5][delta=1.0eps].py
Parameters[eps=0.5][delta=1.5eps].py
</pre></div>
</div>
<p>and we find 6 configuration files. One file for each combination of a value for
<tt class="docutils literal"><span class="pre">eps</span></tt> and one for <tt class="docutils literal"><span class="pre">delta</span></tt>. The file names contain all local parameters as <tt class="docutils literal"><span class="pre">key=value</span></tt>
pairs. These can be used later in the post processing step by the functions from
the <a class="reference internal" href="../waveblocks_classes/FileTools.html#module-FileTools" title="FileTools"><tt class="xref py py-class docutils literal"><span class="pre">FileTools</span></tt></a> sub-module for sorting and grouping the simulations with
respect to almost arbitrary criteria.</p>
<p>These configuration files can now be fed to the main simulation program one
after another as shown in the last section. We could again do this manually but
there is a better solution.</p>
<div class="section" id="valid-meta-configurations">
<h3>Valid Meta-configurations<a class="headerlink" href="#valid-meta-configurations" title="Permalink to this headline">¶</a></h3>
<p>Probably the best approach to write a <cite>metaconfiguration</cite> file is to
copy an existing one from the <tt class="docutils literal"><span class="pre">examples</span></tt> directory. There are some
restrictions to obey when writing <cite>metaconfiguration</cite> files.
(The <tt class="docutils literal"><span class="pre">ConfigurationGenerator</span></tt> is rather brittle.)
The rules for valid files are as follows:</p>
<ul class="simple">
<li>You can use any valid <cite>Python</cite> statement as value</li>
<li>All statements are written to a pure <cite>Python</cite> code file</li>
<li>You can write numbers, lists etc as plain text strings</li>
<li>All that is not in string form gets evaluated <strong>right now</strong></li>
<li>Remember to escape <cite>Python</cite> strings twice</li>
<li>You can use variable references but with great care!</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The ordering of the statements in the output file is such that
all statements can be executed with respect to local variables.
This is some kind of topological sorting. Be warned, it&#8217;s implemented
using black magic and may fail now and then!</p>
</div>
</div>
</div>
<div class="section" id="the-batch-loop">
<h2>The batch loop<a class="headerlink" href="#the-batch-loop" title="Permalink to this headline">¶</a></h2>
<p>There is a simple <cite>Python</cite> script called <tt class="docutils literal"><span class="pre">BatchLoop.py</span></tt> which does nothing else than running
simulations for a set of configurations. The usage is really simple:</p>
<div class="highlight-python"><div class="highlight"><pre>BatchLoop.py --help
usage: BatchLoop.py [-h] -c CONFIGURATIONS [-r RESULTSPATH] [-m MAXWORKERS]

optional arguments:
  -h, --help            show this help message and exit
  -c CONFIGURATIONS, --configurations CONFIGURATIONS
                        Path to the &#39;configuration&#39; directory.
  -r RESULTSPATH, --resultspath RESULTSPATH
                        Path to the &#39;results&#39; directory.
  -m MAXWORKERS, --maxworkers MAXWORKERS
                        Maximal number of parallel jobs.
</pre></div>
</div>
<p>We can run as many simulations as we like. Each simulation is run independently
from all others and there is a limit of <tt class="docutils literal"><span class="pre">MAXWORKERS</span></tt> simulations run in parallel.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The <tt class="docutils literal"><span class="pre">BatchLoop.py</span></tt> command runs only with <cite>Python</cite> 3.4 or later because
of the use of new library features providing support for concurrent execution
of code!</p>
</div>
<p>With the switch <tt class="docutils literal"><span class="pre">-c</span></tt> we have to specify a directory where the configuration files
are located. All <cite>Python</cite> files within that directory (excluding recursive descent)
will be treated as simulation configurations. We can provide (with the switch <tt class="docutils literal"><span class="pre">-r</span></tt>)
also a directory where the simulation results, including numerical data and plots,
will be placed (this defaults to <tt class="docutils literal"><span class="pre">.</span></tt>, the current directory). Usually we will
create a dedicated directory, often called <tt class="docutils literal"><span class="pre">results</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir results
</pre></div>
</div>
<p>Now it is time to call the <tt class="docutils literal"><span class="pre">BatchLoop.py</span></tt> script. The simple call looks like:</p>
<div class="highlight-python"><div class="highlight"><pre>BatchLoop.py -c autogen_configurations -r results
</pre></div>
</div>
<p>This will create new directories in <tt class="docutils literal"><span class="pre">results</span></tt> whose names correspond to the
configuration files used. It will call the <tt class="docutils literal"><span class="pre">Main.py</span></tt> script for each simulation
configuration provided. After this it will run a bunch of data computation and plotting
scripts. If we now look into the results directory by:</p>
<div class="highlight-python"><div class="highlight"><pre>ls results
</pre></div>
</div>
<p>we see the listing:</p>
<div class="highlight-python"><div class="highlight"><pre>Parameters[eps=0.1][delta=0.5eps]
Parameters[eps=0.1][delta=1.0eps]
Parameters[eps=0.1][delta=1.5eps]
Parameters[eps=0.5][delta=0.5eps]
Parameters[eps=0.5][delta=1.0eps]
Parameters[eps=0.5][delta=1.5eps]
</pre></div>
</div>
<p>and for the results of a single simulation (notice the necessary shell character
escapes, you can also write the name without escapes in a pair of <tt class="docutils literal"><span class="pre">&quot;</span></tt>.):</p>
<div class="highlight-python"><div class="highlight"><pre>ls results/Parameters\[eps\=0.1\]\[delta\=0.5eps\]
</pre></div>
</div>
<p>we have the following bunch of files:</p>
<div class="highlight-python"><div class="highlight"><pre>energies_block0.png
energy_drift_block0.png
norms_block0.png
norms_drift_block0.png
norms_sqr_block0.png
Parameters[eps=0.1][delta=0.5eps].py
simulation_results.hdf5
</pre></div>
</div>
<p>Each directory within <tt class="docutils literal"><span class="pre">results</span></tt> contains at least the simulation parameters
file (<tt class="docutils literal"><span class="pre">Parameters[eps=0.1][delta=0.5eps].py</span></tt>) and the simulation results
file (<tt class="docutils literal"><span class="pre">simulation_results.hdf5</span></tt>). If there were some plots generated,
then these files are here too.</p>
</div>
<div class="section" id="running-more-scripts">
<h2>Running more scripts<a class="headerlink" href="#running-more-scripts" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you may wish to run a script for a set of simulations long after the
batch loop has terminated. Maybe you decided to compute a new observable or
whatever. It would be tedious to call the script with each <tt class="docutils literal"><span class="pre">simulation_results.hdf5</span></tt>
and its correct file path manually. Exactly for this reason there is a script named
<tt class="docutils literal"><span class="pre">ForAll.py</span></tt>. For example assume we want to plot the potential used in each simulation
(which is identical in our example but never mind). Then we call:</p>
<div class="highlight-python"><div class="highlight"><pre>ForAll.py PlotPotential.py
</pre></div>
</div>
<p>which starts by printing:</p>
<div class="highlight-python"><div class="highlight"><pre>Will execute the code in &#39;PlotPotential.py&#39; for all files in &#39;results&#39;
 Executing code for datafile in results/Parameters[eps=0.5][delta=1.0eps]
 ...
</pre></div>
</div>
<p>and after a while quits with the text <tt class="docutils literal"><span class="pre">Done</span></tt> on the last output line. The script
can take the path of the directory where the results lie (in the example above
this is <tt class="docutils literal"><span class="pre">./results/</span></tt>) as a third command line argument.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Running multiple simulations</a><ul>
<li><a class="reference internal" href="#preparation-and-meta-configurations">Preparation and Meta-configurations</a><ul>
<li><a class="reference internal" href="#valid-meta-configurations">Valid Meta-configurations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-batch-loop">The batch loop</a></li>
<li><a class="reference internal" href="#running-more-scripts">Running more scripts</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/manual/ch1_s4_batch_loop.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">WaveBlocksND devel documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, R. Bourquin.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>